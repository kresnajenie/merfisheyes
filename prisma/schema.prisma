generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Auth (NextAuth v5) ─────────────────────────────────────────

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts        Account[]
  sessions        Session[]
  catalogDatasets CatalogDataset[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─── Catalog ────────────────────────────────────────────────────

model CatalogDataset {
  id           String  @id @default(cuid())

  // Display metadata
  title        String  @db.VarChar(500)
  description  String? @db.Text
  species      String? @db.VarChar(200)
  disease      String? @db.VarChar(200)
  institute    String? @db.VarChar(500)
  tissue       String? @db.VarChar(200)
  platform     String? @db.VarChar(200)
  tags         String[] @default([])
  thumbnailUrl String? @map("thumbnail_url") @db.VarChar(1000)

  // Link to actual data (one of these is set)
  datasetType  String  @map("dataset_type") @db.VarChar(50) // "single_cell" | "single_molecule"
  s3BaseUrl    String? @map("s3_base_url") @db.VarChar(1000)
  datasetId    String? @map("dataset_id") @db.VarChar(50)
  externalLink String? @map("external_link") @db.VarChar(1000)

  // Publishing
  isPublished  Boolean @default(false) @map("is_published")
  isFeatured   Boolean @default(false) @map("is_featured")
  sortOrder    Int     @default(0) @map("sort_order")

  // Stats (manually entered)
  numCells     Int?    @map("num_cells")
  numGenes     Int?    @map("num_genes")

  // Audit
  createdBy     String?   @map("created_by")
  createdByUser User?     @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@index([isPublished])
  @@index([isFeatured])
  @@index([sortOrder])
  @@map("catalog_datasets")
}

// ─── Dataset Upload (existing) ──────────────────────────────────

model Dataset {
  id             String          @id @db.VarChar(50)
  fingerprint    String          @unique @db.VarChar(64)
  title          String?         @db.VarChar(500)
  numCells       Int             @map("num_cells")
  numGenes       Int             @map("num_genes")
  datasetType    String?         @map("dataset_type") @db.VarChar(50)
  manifestJson   Json?           @map("manifest_json")
  status         DatasetStatus   @default(UPLOADING)
  manifestUrl    String?         @map("manifest_url") @db.VarChar(1000)
  errorMessage   String?         @map("error_message")
  createdAt      DateTime        @default(now()) @map("created_at")
  completedAt    DateTime?       @map("completed_at")
  uploadSessions UploadSession[]

  @@index([fingerprint])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([datasetType])
  @@map("datasets")
}

model UploadSession {
  id             String       @id @db.VarChar(50)
  datasetId      String       @map("dataset_id") @db.VarChar(50)
  totalFiles     Int          @map("total_files")
  completedFiles Int          @default(0) @map("completed_files")
  expiresAt      DateTime     @map("expires_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  files          UploadFile[]
  dataset        Dataset      @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@index([datasetId])
  @@index([expiresAt])
  @@map("upload_sessions")
}

model UploadFile {
  id              String        @id @default(uuid()) @db.Uuid
  uploadSessionId String        @map("upload_session_id") @db.VarChar(50)
  fileKey         String        @map("file_key") @db.VarChar(500)
  fileSize        BigInt?       @map("file_size")
  status          FileStatus    @default(PENDING)
  uploadedAt      DateTime?     @map("uploaded_at")
  errorMessage    String?       @map("error_message")
  uploadSession   UploadSession @relation(fields: [uploadSessionId], references: [id], onDelete: Cascade)

  @@unique([uploadSessionId, fileKey])
  @@index([uploadSessionId])
  @@index([status])
  @@map("upload_files")
}

enum DatasetStatus {
  UPLOADING
  PROCESSING
  COMPLETE
  FAILED
}

enum FileStatus {
  PENDING
  UPLOADING
  COMPLETE
  FAILED
}
